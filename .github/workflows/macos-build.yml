name: macOS build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_NAME: ExcelWide2Long
  ENTRY: wide_to_long_pyqt5.py   # å¦‚æœä½ çš„è„šæœ¬ä¸åœ¨æ ¹ç›®å½•ï¼Œè¿™é‡Œæ”¹æˆç›¸å¯¹è·¯å¾„

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install PyQt5 pandas openpyxl pyinstaller
          fi

      # ğŸ”§ å…³é”®ï¼šæ¸…æ‰æ—§çš„ .spec / build / distï¼Œé¿å… icon é…ç½®æ®‹ç•™
      - name: Clean previous build
        run: |
          rm -f *.spec
          rm -rf build dist

      - name: Build app (icon optional)
        run: |
          ICON_ARG=""
          if [ -f icon.icns ]; then
            ICON_ARG="--icon icon.icns"
            echo "Using icon.icns"
          else
            echo "No icon.icns found, build without icon."
          fi
          pyinstaller --name "$APP_NAME" --windowed --onedir $ICON_ARG "$ENTRY"

      - name: Make DMG
        run: |
          hdiutil create -volname "$APP_NAME" \
            -srcfolder "dist/${APP_NAME}.app" \
            -ov -format UDZO "dist/${APP_NAME}.dmg"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macOS-dist
          path: |
            dist/${{ env.APP_NAME }}.app
            dist/${{ env.APP_NAME }}.dmg
